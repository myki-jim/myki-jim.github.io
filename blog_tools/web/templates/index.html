{% extends "base.html" %}

{% block title %}文章列表 - Hexo 写作工具{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-journal-text"></i> 文章列表</h2>
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="refreshPosts()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
                <a href="{{ url_for('new_post') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> 新建文章
                </a>
            </div>
        </div>

        <!-- 搜索框 -->
        <div class="mb-4">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="搜索文章...">
                <button class="btn btn-outline-secondary" type="button" onclick="searchPosts()">搜索</button>
            </div>
        </div>

        <!-- 文章列表 -->
        <div id="postsList">
            {% if posts %}
                {% for post in posts %}
                <div class="card mb-3 post-card" data-filename="{{ post.filename }}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">
                                    <a href="{{ url_for('edit_post', filename=post.filename) }}" class="text-decoration-none">
                                        {{ post.title }}
                                    </a>
                                </h5>
                                <p class="card-text text-muted small">
                                    <i class="bi bi-calendar3"></i> {{ post.date }} |
                                    <i class="bi bi-folder"></i> {{ post.categories|join(', ') if post.categories else '无分类' }}
                                </p>
                                {% if post.tags %}
                                <div class="mb-2">
                                    {% for tag in post.tags %}
                                    <span class="badge bg-secondary me-1">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="{{ url_for('edit_post', filename=post.filename) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil"></i> 编辑
                                </a>
                                <button class="btn btn-sm btn-outline-success" onclick="openInEditor('{{ post.filename }}')">
                                    <i class="bi bi-code-slash"></i> 编辑器
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-journal-x display-1 text-muted"></i>
                    <h4 class="mt-3">还没有文章</h4>
                    <p class="text-muted">开始创建你的第一篇文章吧！</p>
                    <a href="{{ url_for('new_post') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> 创建第一篇文章
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="col-md-4">
        <!-- 快速操作 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightning"></i> 快速操作</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="startHexoServer()">
                        <i class="bi bi-play-circle"></i> 启动Hexo服务器
                    </button>
                    <button class="btn btn-outline-secondary" onclick="generateSite()">
                        <i class="bi bi-gear"></i> 生成静态文件
                    </button>
                    <button class="btn btn-outline-info" onclick="openBlogInBrowser()">
                        <i class="bi bi-eye"></i> 预览博客
                    </button>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> 统计信息</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary" id="totalPosts">{{ posts|length }}</h4>
                            <small class="text-muted">文章总数</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success" id="gitStatus">未知</h4>
                        <small class="text-muted">Git状态</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 搜索功能
function searchPosts() {
    const keyword = document.getElementById('searchInput').value.trim();
    if (!keyword) {
        refreshPosts();
        return;
    }

    fetch(`/api/search?q=${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('搜索失败: ' + data.error);
                return;
            }
            updatePostsList(data);
        })
        .catch(error => {
            console.error('搜索失败:', error);
            alert('搜索失败，请检查网络连接');
        });
}

// 刷新文章列表
function refreshPosts() {
    fetch('/api/posts')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('加载失败: ' + data.error);
                return;
            }
            updatePostsList(data);
            document.getElementById('totalPosts').textContent = data.length;
        })
        .catch(error => {
            console.error('加载失败:', error);
            alert('加载失败，请检查网络连接');
        });
}

// 更新文章列表显示
function updatePostsList(posts) {
    const postsList = document.getElementById('postsList');
    if (posts.length === 0) {
        postsList.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-journal-x display-1 text-muted"></i>
                <h4 class="mt-3">没有找到文章</h4>
                <p class="text-muted">尝试调整搜索条件或创建新文章</p>
            </div>
        `;
        return;
    }

    let html = '';
    posts.forEach(post => {
        const tagsHtml = post.tags ? post.tags.map(tag =>
            `<span class="badge bg-secondary me-1">${tag}</span>`
        ).join('') : '';

        const categories = post.categories ? post.categories.join(', ') : '无分类';

        html += `
            <div class="card mb-3 post-card" data-filename="${post.filename}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">
                                <a href="/edit/${post.filename}" class="text-decoration-none">
                                    ${post.title}
                                </a>
                            </h5>
                            <p class="card-text text-muted small">
                                <i class="bi bi-calendar3"></i> ${post.date} |
                                <i class="bi bi-folder"></i> ${categories}
                            </p>
                            <div class="mb-2">${tagsHtml}</div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="/edit/${post.filename}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> 编辑
                            </a>
                            <button class="btn btn-sm btn-outline-success" onclick="openInEditor('${post.filename}')">
                                <i class="bi bi-code-slash"></i> 编辑器
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    postsList.innerHTML = html;
}

// 启动Hexo服务器
function startHexoServer() {
    window.open('http://localhost:4000', '_blank');
    alert('请确保在终端运行: npx hexo server');
}

// 生成静态文件
function generateSite() {
    fetch('/generate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('静态文件生成成功！');
            } else {
                alert('生成失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('生成失败:', error);
            alert('生成失败，请检查网络连接');
        });
}

// 在浏览器中打开博客
function openBlogInBrowser() {
    window.open('http://localhost:4000', '_blank');
}

// 在外部编辑器中打开
function openInEditor(filename) {
    // 这里可以添加调用外部编辑器的逻辑
    alert(`请在编辑器中打开: source/_posts/${filename}`);
}

// 页面加载完成后检查Git状态
document.addEventListener('DOMContentLoaded', function() {
    checkGitStatus();
});

// 支持回车搜索
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchPosts();
    }
});
</script>
{% endblock %}