{% extends "base.html" %}

{% block title %}新建文章 - Hexo 写作工具{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> 新建文章</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('create_post') }}">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">文章标题 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" id="title" name="title"
                                       placeholder="输入文章标题..." required>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="tags" class="form-label">标签</label>
                                        <input type="text" class="form-control" id="tags" name="tags"
                                               placeholder="技术, Python, 前端 (用逗号分隔)">
                                        <small class="form-text text-muted">多个标签用逗号分隔</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="categories" class="form-label">分类</label>
                                        <input type="text" class="form-control" id="categories" name="categories"
                                               placeholder="编程, 学习 (用逗号分隔)">
                                        <small class="form-text text-muted">多个分类用逗号分隔</small>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="content" class="form-label">文章内容</label>
                                <div class="border rounded">
                                    <div class="toolbar bg-light p-2 border-bottom">
                                        <div class="btn-group btn-group-sm me-2">
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('**', '**')">
                                                <i class="bi bi-type-bold"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('*', '*')">
                                                <i class="bi bi-type-italic"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('`', '`')">
                                                <i class="bi bi-code"></i>
                                            </button>
                                        </div>
                                        <div class="btn-group btn-group-sm me-2">
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('# ', '')">
                                                H1
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('## ', '')">
                                                H2
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('### ', '')">
                                                H3
                                            </button>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('[', '](url)')">
                                                <i class="bi bi-link"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('![alt text](', ')')">
                                                <i class="bi bi-image"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\\n```\\n', '\\n```\\n')">
                                                <i class="bi bi-code-slash"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\\n- ', '')">
                                                <i class="bi bi-list-ul"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\\n1. ', '')">
                                                <i class="bi bi-list-ol"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\\n<!-- more -->\\n', '')">
                                                More
                                            </button>
                                        </div>
                                    </div>
                                    <textarea class="form-control border-0" id="content" name="content" rows="20"
                                              placeholder="在这里开始写你的内容...&#10;&#10;# 文章标题&#10;&#10;## 引言&#10;&#10;在这里写你的引言内容...&#10;&#10;<!-- more -->&#10;&#10;## 正文&#10;&#10;在这里写正文内容..."></textarea>
                                </div>
                                <small class="form-text text-muted">支持 Markdown 语法，使用 <!-- more --> 标签设置文章摘要</small>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> 写作提示</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="small">
                                        <li>文章标题会自动生成文件名</li>
                                        <li>使用 <code>&lt;!-- more --&gt;</code> 设置文章摘要</li>
                                        <li>支持标准 Markdown 语法</li>
                                        <li>代码块使用三个反引号包围</li>
                                        <li>图片链接格式: <code>![描述](图片地址)</code></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> 快速模板</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('tech')">
                                            技术文章模板
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('note')">
                                            学习笔记模板
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('review')">
                                            项目总结模板
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-eye"></i> 实时预览</h6>
                                </div>
                                <div class="card-body">
                                    <div id="preview" class="small text-muted">
                                        开始输入内容后将显示预览...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> 返回列表
                                </a>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="previewContent()">
                                        <i class="bi bi-eye"></i> 预览
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> 创建文章
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 插入Markdown语法
function insertMarkdown(before, after) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
    textarea.value = newText;

    // 重新设置光标位置
    const newCursorPos = start + before.length + selectedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();

    // 更新预览
    updatePreview();
}

// 插入模板
function insertTemplate(type) {
    const templates = {
        tech: `# 技术文章标题

## 问题描述

在这里描述要解决的技术问题...

## 解决方案

\`\`\`javascript
// 代码示例
function solution() {
    // 你的解决方案
}
\`\`\`

## 实现步骤

1. 第一步
2. 第二步
3. 第三步

## 总结

总结一下实现过程和经验...`,

        note: `# 学习笔记：[主题]

## 学习目标

- 目标一
- 目标二
- 目标三

## 核心概念

### 概念一
解释概念一的含义...

### 概念二
解释概念二的含义...

## 实例分析

\`\`\`
// 实例代码
\`\`\`

## 总结与反思

今天学到了什么，还有什么需要进一步研究...`,

        review: `# 项目总结：[项目名称]

## 项目背景

描述项目的背景和目标...

## 技术栈

- 前端：技术1, 技术2
- 后端：技术3, 技术4
- 数据库：技术5
- 部署：技术6

## 主要功能

1. 功能一：描述
2. 功能二：描述
3. 功能三：描述

## 遇到的挑战

### 挑战一
如何解决的...

### 挑战二
如何解决的...

## 学到的经验

- 经验一
- 经验二
- 经验三

## 未来改进

- 改进点一
- 改进点二`
    };

    const textarea = document.getElementById('content');
    textarea.value = templates[type] || '';
    updatePreview();
}

// 更新预览
function updatePreview() {
    const content = document.getElementById('content').value;
    const preview = document.getElementById('preview');

    if (!content.trim()) {
        preview.innerHTML = '<span class="text-muted">开始输入内容后将显示预览...</span>';
        return;
    }

    // 简单的Markdown预览（实际项目中应该使用专业的Markdown解析库）
    let html = content
        .replace(/^# (.*$)/gim, '<h4>$1</h4>')
        .replace(/^## (.*$)/gim, '<h5>$1</h5>')
        .replace(/^### (.*$)/gim, '<h6>$1</h6>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code>$1</code>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');

    preview.innerHTML = '<p>' + html + '</p>';
}

// 预览内容
function previewContent() {
    const content = document.getElementById('content').value;
    if (!content.trim()) {
        alert('请先输入内容');
        return;
    }

    // 在新窗口中预览
    const previewWindow = window.open('', '_blank');
    previewWindow.document.write(`
        <html>
        <head>
            <title>文章预览</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { max-width: 800px; margin: 0 auto; padding: 20px; }
                .container { max-width: 100%; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>文章预览</h1>
                <hr>
                <div class="content">
                    <pre style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">${content}</pre>
                </div>
            </div>
        </body>
        </html>
    `);
}

// 监听内容变化
document.getElementById('content').addEventListener('input', updatePreview);

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>
{% endblock %}